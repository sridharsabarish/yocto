 # Exercise : Create a layer

## Learning Outcomes

* Learn how layers work in Yocto 
* Learn how to create a new layer in Yocto 
* Learn how to include several recipes to this layer
* Learn how the `layer.conf` file works.
### The tool
`bitbake-layers` is a powerful command, it can do almost everything we want with layers.

## Part 1: Identifying Layers

1. Identify what layers we have in the current poky build!

    <details>
    <summary>hint</summary>
    `Which utility does this?`
    </details>

    <details>
    <summary>Answer</summary>
    - ` bitbake-layers show-layers`
    </details>

    
      
2. There is a file which keeps track of these layers, do you which one it it is?
    <details>
    <summary>hint</summary>
    `bblayers.conf`
    </details>

3. Explore The `bitabake-layers` command and find which command helps us make a new layer.
<details>
<summary>hint</summary>
The help documentation gives us an hint
</details>

<details>
<summary>answer</summary>
	`bitbake-layers create-layer` is used to create a new layer
</details>


## Part 2 : Create a new layers

4. Start by `cd ~/work/poky/poky` and try to create a new layer called `meta-layer1`.
    Now to try the bitbake-layers show-layers command. What do you see? 
    You will notice that this layer has not been added. This has to be added manually by bitbake-layers add-layers command. So add the layer.
    
5. We want the layer to have a value for priority that is bigger than the other layers, can you find how to do that?

<details>
<summary>hint</summary>
There is a file inside this layer which can be used to set the priority!
</details>

<details>
<summary>Answer</summary>
- look for the file `layer.conf` inside the `conf` folder.
- Here we can set the priority using `BBFILE_PRIORITY_meta-layer1 = "100"`
</details>

6. Go to the `example.bb` in this layer and modify the text in the `do_display_banner` as  Example layer 1 recipe created by `bitbake-layers`.

### Adding a new layer

7. Now go back to `cd ~/work/poky/poky` and create a new layer called `meta-layer2` without changing the default values.  Modify the `example.bb` by adding the text `Example layer 2 recipe created by bitbake-layers`   
8. Try to build this recipe using `bitbake example` and see what you get as output!


<details>
<summary>hint</summary>
How does priority affect a layer?
</details>

<details>
<summary>Answer</summary>
- The layer with highest prio is executed, so our recipe in layer1 with priority 100 is executed instead of the newly created layer.
</details>


##  Part 3 - Changing the location of recipes.

* Create a new layer called `meta-layer3`
9. Move the recipe from `/home/yocto/work/poky/poky/meta-layer3/recipes-example/example`  to `/home/yocto/work/poky/poky/meta-layer3/recipes-example/` and rename it as `layer3.bb`
10. Try to build this recipe? Does it work?
<details>
<summary>hint</summary>
Is it in our path?
</details>

<details>
<summary>answer</summary>
	It wouldn't work as the location is not our BBFILE path!
</details>
  
11.   Maybe there is a way to to solve this? Can you find and edit the metadata in `layer.conf` that could solve this mess? Once done, try building the recipe again!
<details>
<summary>hint</summary>
we are dealing with files right?
</details>

<details>
<summary>answer</summary>
	 Remove the one extra /* in the bbfiles this would make it possible to soearch the recipe in our folder.
	 
	`BBFILES += "${LAYERDIR}/recipes-*/*.bb \
            ${LAYERDIR}/recipes-*/*.bbappend"`

</details>

## Part 4 - Removing a layer

12.  Now its time to remove layer3 and layer 1. What command can we use?
<details>
<summary>hint</summary>
its also a bitbake-layers command
</details>
   <details>
	<summary>Answer</summary>
	`bitbake-layers remove-layer meta-layer1`
	`bitbake-layers remove-layer meta-layer3`
</details>

13. What happens when you build now?
<details>
<summary>hint</summary>
Where can i find example.bb?
</details>
   <details>
	<summary>Answer</summary>
	Example.bb is only found in layer2 so it is executed!
</details>

14. Which of the following is true?
    1. If there is just one recipe, but it is in a layer with low priority it is not executed?
    2. If there are multiple recipes, then the recipe from the highest prioirty layer is executed?
    3. If there are multiple recipes, then the recipe with the higest epoch/version is executed irrespective of layer priority?
    4. If a layer has lower priority, even the recipes which are not found in other layers are also not executed.
    5. If there is just one recipe in all the layers, then it is executed no matter what!

</details>
   <details>
	<summary>Answer</summary>
	2 and 5
</details>

## Additional Exercises
15. Open the website where you can find layers and find a new software layers and try to clone it your machine. Do not add it to your machine, just try to Observe how the recipes are created and see if the structure make sense
16. Do the same for a distro layer and a machine BSP layer!