
# Exercise : Create your own Custom Distro

## Learning Objective
- Learn how to add distro features to your image
- Learn how to create your own distro.
## Part 1: Explore a distro
Distro layers are used to define information about a Linux Distro
A typical distro layer looks like this.

		├── distro
		│   ├── include
		│   │   ├──someincludes.inc
		│   │   ├── someinclude2inc
		│   ├── distro1.conf
		│   ├──distro2.conf
		├── layer.conf


1. There are several distros that are provided to us by the meta-poky layer. Can you find them all?
   <details>
   <summary>Answer</summary>
    - The distros are `poky`,`poky-tiny`,`poky-altcfg`,`poky-bleeding`
   </details>

2. Which of these distros will require `opkg` to install its packages?
   <details>
   <summary>hint</summary>
    Try to find which packge format uses `opkg` as its package manager?
</details>
   <details>
   <summary>Answer</summary>
   - `opkg` is used by `ipk` formats
   -  in `poky-altcfg.conf` ithe `PACKAGE_CLASSES` is set to `package_ipk`
   </details>

3. What does `DISTROOVERRIDES` in line 36 of `poky-tiny.conf` do?
   <details>
   <summary>hint</summary>
    Check [here](https://docs.yoctoproject.org/ref-manual/variables.html#term-DISTROOVERRIDES)  
</details>
   <details>
   <summary>Answer</summary>
   - Basically it sets the default value of the OVERRIDES variable to poky and poky tiny. so we can basically define metatdata with poky-tiny override and it it would work right out of the box!
   </details>


4. Does `poky-tiny` use the same kernel as the `poky-bleeding`?
   <details>
   <summary>hint</summary>
    What does `PREFERRED_PROVIDER` do? 
</details>
   <details>
   <summary>Answer</summary>
   - In `poky-tiny.conf`, preferred provider is used to set the `linux-yocto-tiny` as its kernel, so no they are not using the same kernel!!
   </details>


5. How can one add support for `wifi` in `poky-tiny`?
   <details>
   <summary>hint</summary>
   Maybe the comments help? 
</details>
   <details>
   <summary>Answer</summary>
   - Setting the `DISTRO_FEATURES_WIFI = "Wifi" `would enable wifi in poky-tiny!!
   </details>

6. which of the distribution supports `systemd`?
   <details>
   <summary>hint</summary>
    Try grepping for systemd 
</details>
   <details>
   <summary>Answer</summary>
   -  In `poky-altcfg.conf` we can see that if the musl override is not set, we can use systemd with `poky-altcfg` distro!!
   </details>

## Part 2 : Create a new layer for Distro

7. Now that we know how a distro looks like, can you create a new distro called `afry`, note this should be in a new layer.
   <details>
   <summary>hint</summary>
    Use `bitbake-layers` to create new layer. How is a layer named in yocto?
</details>
   <details>
   <summary>Answer</summary>
   -  `bitbake-layers create-layer meta-afry`
   -  `bitbake-layer add-layer meta-afry`
   </details>
   
8. Now create the directory structure for a distro.
   <details>
   <summary>hint</summary>
    How does poky distros look like?
</details>
   <details>
   <summary>Answer</summary>
   -  inside `conf` create a directory called `distro`
   </details>

9. You should create a `.conf` file , how should it be named?
   <details>
   <summary>hint</summary>
 Maybe this is the name of the distro. How do we want to name our distro?
</details>
   <details>
   <summary>Answer</summary>
   -  it should be `afry.conf`
   </details>
   
10. Create the Base for the distro from `Poky.conf`
   <details>
   <summary>hint</summary>
   Should we always copy? or is there a simpler way out?
</details>
   <details>
   <summary>Answer</summary>
   -   Add this line to your conf file! 
     `require conf/distro/poky.conf` 
   </details>

11. Using Poky or poky-tiny as reference can you populate the following for our distro?
	1. Name of the distro?
	2. What are its overrides by default?
	3. What is its version?
	4. Any code names?
   <details>
   <summary>hint</summary>
   What variables does poky use?
</details>
   <details>
   <summary>Answer</summary>
	
	- `DISTRO= "afry"` 
	- `DISTRO_NAME = "AFRY"` 
	- `DISTROOVERRIDES = "poky:afry"`
	- `DISTRO_VERSION = "1.0.0"` 
	- `DISTRO_CODENAME = "makingfuture"`
	
	




   </details>

**Note :** Remember to create Software Bill of material, poky inherits this by default but good to keep in mind.

`INHERIT += "create-spdx"`

# Capstone Challenge - Do it at home, not on this VM.

**Note : Building a new architecture/distro in this machine would  cause two issues**
1. **Storage Space issues**
2. **delete the previous created images and files. So if you want to refer and retry this material at home, don't use this VM.**

## For the brave
If you decide to use this VM for this challenge, you could  delete `/build/tmp/work` folder. This would give you space to build. However the new build would take 6 hours. 

**So it is recommended to try this capstone challenge in a separate machine later.**

## Thinking
For now just think about how you can do this!!
1. Create a linux distribution
	1. **Architecture :** It should be for `qemuarm` architecture.
	2. **Root file system** should be 10GB and should have an extra space of 1gb.
	3. **Packages :** Apart from the base packages, we need the following package
		packagegroup-core-full-cmdline-utils
		packagegroup-core-full-cmdline-multiuser 
		packagegroup-core-full-cmdline-dev-utils
		Hint : Remember to check  how core-image-full-cmdline add the packaging support. This has to do with package groups and you need to create your own image.
	4. **Recipes and layers**: There should be atleast 2 layers and 3 recipes in each of these layers and the recipe should create a file in your home folder. 
	5. **Customization :** Use package config to enable a dependency between your recipe.
	6.  All these recipes are to be present in this image, find a way to verify this.
	7. **Kernel :** Try to modify the kernel setttings, generate a cfg fragment and include the fragment. Some examples inlude support for CAN Bus. Be creative.
	8. **DISTRO :** A custom distro should be used. We can go with "afry" distro created in the previous section.
	9. **Pacakaging support :** It should have the following package support
		1. npm
		2. deb
		3. ipk
	8. Troubleshooting : Enable GDB and also include support for profiling.


## To note:
###  Update the local.conf
Change the value of `DISTRO` to `afry` here. otherwise poky will be used as the distro from local.conf
5. This would make sure that the new distro is used for the new builds.

Now you are ready. Build it up. Take a nap, it should be done over night!! Good luck!!
# References
1. [Creating your own distro](https://docs.yoctoproject.org/dev-manual/custom-distribution.html)
2. [DISTRO Layer](https://docs.yoctoproject.org/overview-manual/concepts.html#distro-layer)